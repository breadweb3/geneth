package ribose_test

import (
	"bytes"
	"encoding/hex"
	"testing"

	"github.com/ethereum/go-ethereum/consensus/ribose"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/systemcontracts"
	"github.com/stretchr/testify/assert"
)

func TestUpgrade(t *testing.T) {
	genspec := ribose.NewTestGenesisBlock(t)
	systemcontracts.AbiesUpgrade.Networks[genspec.Config.ChainID.String()] = &systemcontracts.Upgrades{
		systemcontracts.RiboseContractAddr: systemcontracts.Upgrade{
			CommitUrl: "",
			Code:      "6080604052600436106102725760003560e01c80639e9c9b3f1161014f578063c72841d4116100c1578063e07d91e01161007a578063e07d91e014610c78578063e65a784514610c8d578063e866e53114610ca2578063ea7221a114610cd5578063f39fa40f14610d08578063facd743b14610db857610272565b8063c72841d414610bd0578063c967f90f14610be5578063d220ac8214610bfa578063d6c0edad14610c28578063d748ed2914610c30578063db78dd2814610c6357610272565b8063adc9772e11610113578063adc9772e146109f5578063b39c2bfc14610a21578063b7ab4db514610a5a578063b7bc7f1c14610a6f578063beb50e1d14610b1d578063c3999fa714610b9d57610272565b80639e9c9b3f146108fa578063a224cee71461090f578063a2bc66be1461098c578063a478a663146109cb578063a8fad46d146109e057610272565b806355d888f8116101e857806373696086116101ac578063736960861461078757806377f7f585146107c25780637f4f95fa146108455780638a6bc2f8146108805780638d407f24146108b95780638e872bb7146108ce57610272565b806355d888f8146105dd5780635c395e1c146105f257806366c64eb714610625578063673987db146107405780636a16b1611461075557610272565b80631f9d6c7f1161023a5780631f9d6c7f1461035d5780632bed25f7146104d4578063317b662814610532578063346e4eb51461057857806335aa2e441461058d57806336771a9d146105b757610272565b8063013018a7146102775780630ecd1d4b146102c457806314bfb52714610300578063158ef93e146103335780631aa3a00814610348575b600080fd5b34801561028357600080fd5b506102b06004803603604081101561029a57600080fd5b506001600160a01b038135169060200135610deb565b604080519115158252519081900360200190f35b3480156102d057600080fd5b506102ee600480360360208110156102e757600080fd5b5035610e4a565b60408051918252519081900360200190f35b34801561030c57600080fd5b506102b06004803603602081101561032357600080fd5b50356001600160a01b0316610e6b565b34801561033f57600080fd5b506102b0610e90565b34801561035457600080fd5b506102b0610e99565b34801561036957600080fd5b506103906004803603602081101561038057600080fd5b50356001600160a01b03166110ec565b60405180806020018060200180602001848103845287818151815260200191508051906020019080838360005b838110156103d55781810151838201526020016103bd565b50505050905090810190601f1680156104025780820380516001836020036101000a031916815260200191505b50848103835286518152865160209182019188019080838360005b8381101561043557818101518382015260200161041d565b50505050905090810190601f1680156104625780820380516001836020036101000a031916815260200191505b50848103825285518152855160209182019187019080838360005b8381101561049557818101518382015260200161047d565b50505050905090810190601f1680156104c25780820380516001836020036101000a031916815260200191505b50965050505050505060405180910390f35b3480156104e057600080fd5b50610507600480360360208110156104f757600080fd5b50356001600160a01b03166113b5565b6040805195865260208601949094528484019290925260608401526080830152519081900360a00190f35b34801561053e57600080fd5b5061055c6004803603602081101561055557600080fd5b503561169c565b604080516001600160a01b039092168252519081900360200190f35b34801561058457600080fd5b506102ee6116c6565b34801561059957600080fd5b5061055c600480360360208110156105b057600080fd5b50356116cb565b6102b0600480360360208110156105cd57600080fd5b50356001600160a01b03166116db565b3480156105e957600080fd5b506102ee611731565b3480156105fe57600080fd5b506102b06004803603602081101561061557600080fd5b50356001600160a01b031661173d565b34801561063157600080fd5b506102b06004803603606081101561064857600080fd5b810190602081018135600160201b81111561066257600080fd5b82018360208201111561067457600080fd5b803590602001918460018302840111600160201b8311171561069557600080fd5b919390929091602081019035600160201b8111156106b257600080fd5b8201836020820111156106c457600080fd5b803590602001918460018302840111600160201b831117156106e557600080fd5b919390929091602081019035600160201b81111561070257600080fd5b82018360208201111561071457600080fd5b803590602001918460018302840111600160201b8311171561073557600080fd5b50909250905061187b565b34801561074c57600080fd5b506102ee611ae8565b34801561076157600080fd5b5061076a611af4565b6040805167ffffffffffffffff9092168252519081900360200190f35b34801561079357600080fd5b506102ee600480360360408110156107aa57600080fd5b506001600160a01b0381358116916020013516611afa565b3480156107ce57600080fd5b506107f5600480360360208110156107e557600080fd5b50356001600160a01b0316611b9a565b60408051602080825283518183015283519192839290830191858101910280838360005b83811015610831578181015183820152602001610819565b505050509050019250505060405180910390f35b34801561085157600080fd5b506105076004803603604081101561086857600080fd5b506001600160a01b0381358116916020013516611c10565b34801561088c57600080fd5b506102b0600480360360408110156108a357600080fd5b506001600160a01b038135169060200135611c9e565b3480156108c557600080fd5b506102ee611cf4565b3480156108da57600080fd5b506108e3611cfa565b6040805161ffff9092168252519081900360200190f35b34801561090657600080fd5b5061055c611cff565b34801561091b57600080fd5b5061098a6004803603602081101561093257600080fd5b810190602081018135600160201b81111561094c57600080fd5b82018360208201111561095e57600080fd5b803590602001918460208302840111600160201b8311171561097f57600080fd5b509092509050611d05565b005b34801561099857600080fd5b506102b0600480360360608110156109af57600080fd5b506001600160a01b03813516906020810135906040013561216b565b3480156109d757600080fd5b506102ee6121c8565b3480156109ec57600080fd5b506102ee6121cd565b6102b060048036036040811015610a0b57600080fd5b506001600160a01b0381351690602001356121d5565b348015610a2d57600080fd5b506102b060048036036040811015610a4457600080fd5b506001600160a01b03813516906020013561222a565b348015610a6657600080fd5b506107f5612280565b348015610a7b57600080fd5b50610a846122e2565b604051808060200180602001838103835285818151815260200191508051906020019060200280838360005b83811015610ac8578181015183820152602001610ab0565b50505050905001838103825284818151815260200191508051906020019060200280838360005b83811015610b07578181015183820152602001610aef565b5050505090500194505050505060405180910390f35b348015610b2957600080fd5b50610b5060048036036020811015610b4057600080fd5b50356001600160a01b0316612400565b604080516001600160a01b0390991689526020890197909752878701959095526060870193909352608086019190915260a085015260c0840152151560e083015251908190036101000190f35b348015610ba957600080fd5b506102b060048036036020811015610bc057600080fd5b50356001600160a01b031661272a565b348015610bdc57600080fd5b506108e3612785565b348015610bf157600080fd5b506108e361278a565b348015610c0657600080fd5b50610c0f6121cd565b6040805163ffffffff9092168252519081900360200190f35b61098a61278f565b348015610c3c57600080fd5b506102b060048036036020811015610c5357600080fd5b50356001600160a01b0316612abb565b348015610c6f57600080fd5b5061076a612b18565b348015610c8457600080fd5b506102ee612b1f565b348015610c9957600080fd5b506102ee612b27565b348015610cae57600080fd5b506102b060048036036020811015610cc557600080fd5b50356001600160a01b0316612b2c565b348015610ce157600080fd5b5061098a60048036036020811015610cf857600080fd5b50356001600160a01b0316612d43565b348015610d1457600080fd5b5061098a60048036036040811015610d2b57600080fd5b810190602081018135600160201b811115610d4557600080fd5b820183602082011115610d5757600080fd5b803590602001918460208302840111600160201b83111715610d7857600080fd5b9190808060200260200160405190810160405280939291908181526020018383602002808284376000920191909152509295505091359250612fb7915050565b348015610dc457600080fd5b506102b060048036036020811015610ddb57600080fd5b50356001600160a01b0316613255565b60015460009060ff16610e34576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b610e4183336000856132a7565b90505b92915050565b60008181548110610e5a57600080fd5b600091825260209091200154905081565b6001600160a01b0381166000908152600260205260409020600e015460ff165b919050565b60015460ff1681565b60015460009060ff16610ee2576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b3360008181526002602052604090206010015415610f3c576040805162461bcd60e51b8152602060048201526012602482015271105b1c9958591e481c9959da5cdd195c995960721b604482015290519081900360640190fd5b610f44614b05565b6001600160a01b03821660608201819052632faf0800608083015242610220830152436101a08301526000908152600260209081526040909120825180518493610f92928492910190614ba1565b506020828101518051610fab9260018501920190614ba1565b5060408201518051610fc7916002840191602090910190614ba1565b50606082015160038201805460808501516001600160a01b03199091166001600160a01b039384161763ffffffff60a01b1916600160a01b63ffffffff9092169190910217905560a0830151600483015560c0830151600583015560e08301516006830155610100830151600783015561012083015160088301556101408301516009830155610160830151600a830155610180830151600b8301556101a0830151600c8301556101c0830151600d8301556101e0830151600e8301805460ff1916911515919091179055610200830151600f83015561022090920151601090910155604080514281529051918416917f62549d9227023681a56f9f6e74ba14dd3701fa54635dc81ec7dc4b0e2949a777916020908290030190a26001925050505b90565b6001600160a01b038116600090815260026020818152604080842081518154600181161561010002600019011694909404601f8101849004909302840161026090810190925261024084018381526060958695869591949093928492909184919084018282801561119e5780601f106111735761010080835404028352916020019161119e565b820191906000526020600020905b81548152906001019060200180831161118157829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156112405780601f1061121557610100808354040283529160200191611240565b820191906000526020600020905b81548152906001019060200180831161122357829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f810183900483028501830190915280845293810193908301828280156112d25780601f106112a7576101008083540402835291602001916112d2565b820191906000526020600020905b8154815290600101906020018083116112b557829003601f168201915b505050918352505060038201546001600160a01b038116602080840191909152600160a01b90910463ffffffff166040808401919091526004840154606084015260058401546080840152600684015460a0840152600784015460c0840152600884015460e08401526009840154610100840152600a840154610120840152600b840154610140840152600c840154610160840152600d840154610180840152600e84015460ff1615156101a0840152600f8401546101c08401526010909301546101e09092019190915282519083015192909101519097919650945092505050565b6001600160a01b038116600090815260026020818152604080842081518154600181161561010002600019011694909404601f81018490049093028401610260908101909252610240840183815285948594859485948594909284928491908401828280156114655780601f1061143a57610100808354040283529160200191611465565b820191906000526020600020905b81548152906001019060200180831161144857829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156115075780601f106114dc57610100808354040283529160200191611507565b820191906000526020600020905b8154815290600101906020018083116114ea57829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f810183900483028501830190915280845293810193908301828280156115995780601f1061156e57610100808354040283529160200191611599565b820191906000526020600020905b81548152906001019060200180831161157c57829003601f168201915b505050918352505060038201546001600160a01b0381166020830152600160a01b900463ffffffff9081166040830152600483015460608301526005830154608080840191909152600684015460a080850191909152600785015460c080860191909152600886015460e080870191909152600987015461010080880191909152600a880154610120880152600b880154610140880152600c880154610160880152600d880154610180880152600e88015460ff1615156101a0880152600f8801546101c08801526010909701546101e090960195909552918601519086015191860151938601519590940151939091169b909a50909850919650945092505050565b600681815481106116ac57600080fd5b6000918252602090912001546001600160a01b0316905081565b603081565b600781815481106116ac57600080fd5b60015460009060ff16611724576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b610e4482333460006132a7565b670de0b6b3a764000081565b60015460009060ff16611786576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b6001600160a01b038216600090815260056020526040902054806117e9576040805162461bcd60e51b81526020600482015260156024820152744e6f2070726f66697420746f20776974686472617760581b604482015290519081900360640190fd5b6040516001600160a01b0384169082156108fc029083906000818181858888f1935050505015801561181f573d6000803e3d6000fd5b506001600160a01b038316600081815260056020908152604080832092909255815142815291518493927f54f6473133bd53384948e047045798466262939bddc69341a06f57ce54bb5f0c92908290030190a350600192915050565b60015460009060ff166118c4576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b33600081815260026020526040902060100154611923576040805162461bcd60e51b815260206004820152601860248201527710d85b991a59185d19481b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b61010087111561197a576040805162461bcd60e51b815260206004820152601960248201527f496e76616c69646174652077656273697465206c656e67746800000000000000604482015290519081900360640190fd5b6101008511156119d1576040805162461bcd60e51b815260206004820152601760248201527f496e76616c696461746520656d61696c206c656e677468000000000000000000604482015290519081900360640190fd5b611000831115611a28576040805162461bcd60e51b815260206004820152601960248201527f496e76616c69646174652064657461696c73206c656e67746800000000000000604482015290519081900360640190fd5b6001600160a01b0381166000908152600260205260409020611a4b908989614c2d565b506001600160a01b0381166000908152600260205260409020611a72906001018787614c2d565b506001600160a01b0381166000908152600260208190526040909120611a9a91018585614c2d565b506040805142815290516001600160a01b038316917fbcad83659384758f4261b23615a13d03ae1c1629e87d0e5554fb60a126feadf6919081900360200190a2506001979650505050505050565b6729a2241af62c000081565b61708081565b6001600160a01b0380831660009081526002602081815260408084206007015460038352818520958716855294909152822001549091908082038015611b8e576001600160a01b03868116600090815260036020908152604080832093891683529290529081208054600190910154611b739190613621565b90506000611b81838361367e565b9550610e44945050505050565b50600095945050505050565b6001600160a01b038116600090815260046020908152604091829020805483518184028101840190945280845260609392830182828015611c0457602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311611be6575b50505050509050919050565b6001600160a01b0382811660009081526003602090815260408083209385168352929052908120805460019091015482918291829182918291611c5291613621565b6001600160a01b0398891660009081526003602081815260408084209b909c16835299909952989098208054600182015460028301549290990154909a98999891975095509350505050565b60015460009060ff16611ce7576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b610e418333600085613693565b6104b081565b600581565b61c00081565b60015460ff1615611d53576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b6015811115611d9f576040805162461bcd60e51b8152602060048201526013602482015272546f6f206d616e792076616c696461746f727360681b604482015290519081900360640190fd5b6000805460018181018355828052671bc16d674ec800007f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5639283015582548082018455670de0b6b3a764000090830155825480820184556706f05b59d3b2000090830155825480820184556703782dace9d9000090830155825480820184556701bc16d674ec8000908301819055835491820184559101555b8181101561215a576000838383818110611e4e57fe5b905060200201356001600160a01b03166001600160a01b03161415611eba576040805162461bcd60e51b815260206004820152601960248201527f496e76616c69642076616c696461746f72206164647265737300000000000000604482015290519081900360640190fd5b6000838383818110611ec857fe5b6001600160a01b03602091820293909301358316600081815260029092526040909120600301549093509091161515905061209f57611f05614b05565b6001600160a01b038216606082015242610220820152436101a08201528060026000878787818110611f3357fe5b905060200201356001600160a01b03166001600160a01b03166001600160a01b031681526020019081526020016000206000820151816000019080519060200190611f7f929190614ba1565b506020828101518051611f989260018501920190614ba1565b5060408201518051611fb4916002840191602090910190614ba1565b506060820151600382018054608085015163ffffffff16600160a01b0263ffffffff60a01b196001600160a01b039094166001600160a01b0319909216919091179290921691909117905560a0820151600482015560c0820151600582015560e08201516006820155610100820151600782015561012082015160088201556101408201516009820155610160820151600a820155610180820151600b8201556101a0820151600c8201556101c0820151600d8201556101e0820151600e8201805491151560ff19909216919091179055610200820151600f82015561022090910151601090910155505b6120a881613255565b6120f857600780546001810182556000919091527fa66cc928b5edb82af9bd49922954155ab7b0942694bea4ce44661d9a8736c6880180546001600160a01b0319166001600160a01b0383161790555b6121018161272a565b61215157600680546001810182556000919091527ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b0383161790555b50600101611e38565b50506001805460ff19168117905550565b60015460009060ff166121b4576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b6121c084338585613693565b949350505050565b600c81565b633b9aca0081565b60015460009060ff1661221e576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b610e41833334856132a7565b60015460009060ff16612273576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b610e418333846000613693565b606060078054806020026020016040519081016040528092919081815260200182805480156122d857602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116122ba575b5050505050905090565b606080600060068054905067ffffffffffffffff8111801561230357600080fd5b5060405190808252806020026020018201604052801561232d578160200160208202803683370190505b50905060005b60065481101561239757600260006006838154811061234e57fe5b60009182526020808320909101546001600160a01b03168352820192909252604001902060040154825183908390811061238457fe5b6020908102919091010152600101612333565b50600681818054806020026020016040519081016040528092919081815260200182805480156123f057602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116123d2575b5050505050915092509250509091565b6001600160a01b038116600090815260026020818152604080842081518154600181161561010002600019011694909404601f810184900490930284016102609081019092526102408401838152859485948594859485948594859485949193928492909184918401828280156124b85780601f1061248d576101008083540402835291602001916124b8565b820191906000526020600020905b81548152906001019060200180831161249b57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561255a5780601f1061252f5761010080835404028352916020019161255a565b820191906000526020600020905b81548152906001019060200180831161253d57829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f810183900483028501830190915280845293810193908301828280156125ec5780601f106125c1576101008083540402835291602001916125ec565b820191906000526020600020905b8154815290600101906020018083116125cf57829003601f168201915b505050505081526020016003820160009054906101000a90046001600160a01b03166001600160a01b03166001600160a01b031681526020016003820160149054906101000a900463ffffffff1663ffffffff1663ffffffff168152602001600482015481526020016005820154815260200160068201548152602001600782015481526020016008820154815260200160098201548152602001600a8201548152602001600b8201548152602001600c8201548152602001600d8201548152602001600e820160009054906101000a900460ff16151515158152602001600f820154815260200160108201548152505090508060600151816101200151826101400151836102200151846101600151856101800151866101a00151876101e001519850985098509850985098509850985050919395975091939597565b6000805b60065481101561277c57826001600160a01b03166006828154811061274f57fe5b6000918252602090912001546001600160a01b03161415612774576001915050610e8b565b60010161272e565b50600092915050565b603281565b601581565b3341146127d0576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b43600090815260086020908152604080832083805290915290205460ff1615612840576040805162461bcd60e51b815260206004820152601960248201527f426c6f636b20697320616c726561647920726577617264656400000000000000604482015290519081900360640190fd5b60015460ff16612886576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b4360009081526008602090815260408083208380529091528120805460ff19166001179055339034906128b7613a64565b6001600160a01b03841660009081526002602052604090206008810180548301905560098101805485019055600e01549091508282019060ff16156129475760006129028286613aaa565b905060006129108383613c3d565b90508015612940576001600160a01b0386166000908152600260205260409020600b015461293e9082613c7f565b505b5050612a75565b6001600160a01b038416600090815260026020526040902060030154600160a01b900463ffffffff161580159061299857506001600160a01b03841660009081526002602052604090206004015415155b15612a4a576001600160a01b038416600090815260026020526040812060038101546004909101546129d891600160a01b900463ffffffff169084613cd9565b6001600160a01b0386166000908152600260205260408120600781018054840190556004015491925090612a1d90633b9aca0090612a17908590613cf5565b90613c3d565b6001600160a01b0387166000908152600260205260409020600b018054918503909101905550612a6c9050565b6001600160a01b0384166000908152600260205260409020600b018054820190555b612a7584613d4e565b60408051428152905182916001600160a01b038716917f7dc4e5df59513708dca355b8706273a5df7b810a4cec8019f2a4b9bb166a1a049181900360200190a350505050565b60015460009060ff16612b04576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b33612b0f8382613e02565b50600192915050565b6201518081565b6301312d0081565b601881565b60015460009060ff16612b75576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b6001600160a01b038216600090815260026020526040902060100154612bdd576040805162461bcd60e51b815260206004820152601860248201527710d85b991a59185d19481b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b6001600160a01b038281166000908152600260205260409020600301543391168114612c3a5760405162461bcd60e51b8152600401808060200182810382526039815260200180614d6d6039913960400191505060405180910390fd5b612c4383613d4e565b6001600160a01b0383166000908152600260205260409020600a015480612ca9576040805162461bcd60e51b81526020600482015260156024820152744e6f2070726f66697420746f20776974686472617760581b604482015290519081900360640190fd5b6040516001600160a01b0383169082156108fc029083906000818181858888f19350505050158015612cdf573d6000803e3d6000fd5b506001600160a01b038085166000818152600260209081526040808320600a0192909255815142815291518594871693927f81edb7ebd2e35f5b90586ddcbc6cce694a2fa4758e628c3bbf2d207cc60f866a92908290030190a45060019392505050565b334114612d84576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b60015460ff16612dca576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b4360009081526009602052604090205460ff1615612e22576040805162461bcd60e51b815260206004820152601060248201526f105b1c9958591e481c1d5b9a5cda195960821b604482015290519081900360640190fd5b436000908152600960209081526040808320805460ff191660019081179091556001600160a01b03851684526002909252909120600d81018054909201909155600f015415612f05576001600160a01b0381166000908152600260205260408120600f0154612e959043036104b0613c3d565b6001600160a01b0383166000908152600260205260409020600d0154909150811015612ee2576001600160a01b0382166000908152600260205260409020600d0180548290039055612f03565b6001600160a01b03821660009081526002602052604090206001600d909101555b505b6001600160a01b038116600090815260026020526040902043600f820155600d015460309006612f4757612f398133613ecd565b612f4281613f5c565b612f75565b6001600160a01b0381166000908152600260205260409020600d015460189006612f7557612f758133613ecd565b6040805142815290516001600160a01b038316917f770e0cca42c35d00240986ce8d3ed438be04663c91dac6576b79537d7c180f1e919081900360200190a250565b60015460ff16612ffd576040805162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b604482015290519081900360640190fd5b33411461303e576040805162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b604482015290519081900360640190fd5b4360009081526008602090815260408083206001845290915290205460ff16156130af576040805162461bcd60e51b815260206004820152601a60248201527f56616c696461746f727320616c72656164792075706461746564000000000000604482015290519081900360640190fd5b808043816130b957fe5b06156130ff576040805162461bcd60e51b815260206004820152601060248201526f426c6f636b2065706f6368206f6e6c7960801b604482015290519081900360640190fd5b43600090815260086020908152604080832060018085529252909120805460ff191690911790558251613170576040805162461bcd60e51b815260206004820152601460248201527356616c696461746f722073657420656d7074792160601b604482015290519081900360640190fd5b8251601510156131c7576040805162461bcd60e51b815260206004820152601860248201527f56616c696461746f722073657420746f6f206c61726765210000000000000000604482015290519081900360640190fd5b82516131da906007906020860190614ca9565b507feacea8f3c22f06c0b18306bdb04d0a967255129e8ce0094debb0a0ff89d006b5836040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561323d578181015183820152602001613225565b505050509050019250505060405180910390a1505050565b6000805b60075481101561277c57826001600160a01b03166007828154811061327a57fe5b6000918252602090912001546001600160a01b0316141561329f576001915050610e8b565b600101613259565b6001600160a01b03841660009081526002602052604081206010015461330f576040805162461bcd60e51b815260206004820152601860248201527710d85b991a59185d19481b9bdd081c9959da5cdd195c995960421b604482015290519081900360640190fd5b670de0b6b3a76400008310158061332e57506729a2241af62c00008210155b61337f576040805162461bcd60e51b815260206004820152601a60248201527f5374616b696e6720524e412f41524d206e6f7420656e6f756768000000000000604482015290519081900360640190fd5b81156133935761339361c0008530856141e9565b6001600160a01b038086166000908152600360208181526040808420948916845293905291902001546134d8576001600160a01b03841660009081526004602052604090205460051161342d576040805162461bcd60e51b815260206004820152601a60248201527f5374616b656420746f6f206d616e792063616e64696461746573000000000000604482015290519081900360640190fd5b6134378486614345565b61343f614cfe565b83815260208082018481526001600160a01b03808916600081815260028086526040808320600701548189019081524360608a019081529484526003808952828520968e1685529590975282208751815594516001860155945194840194909455519101556134ae8585613621565b6001600160a01b038816600090815260026020526040902060040180549091019055506135949050565b6134e28585613e02565b6001600160a01b0385811660009081526003602090815260408083209388168352929052908120805460019091015461351b9190613621565b6001600160a01b038781166000908152600360208181526040808420948b168452939052918120805488018082556001820180548901908190554392909401919091559293509161356b91613621565b6001600160a01b0388166000908152600260205260409020600401805493909103909201909155505b6001600160a01b0380861660008181526002602090815260409182902060058101805489019055600601805487019055815187815290810186905242818301529051928716927f564d8aa8066a908567a10a904837b61b781826e05234f79979c816fc3dd1de9f9181900360600190a361360d856143f9565b61361685614534565b506001949350505050565b60008261363057506000610e44565b6725b946ebc0b361748211613646575081610e44565b670de0b6b3a7640000600061365b84836147c8565b90506000613668826147d5565b90506136748187614800565b9695505050505050565b6000806121c0633b9aca00612a178587613cf5565b6001600160a01b03808516600090815260036020908152604080832093871683529290529081205483111561370f576040805162461bcd60e51b815260206004820152601960248201527f4e6f7420656e6f75676820524e4120746f20756e7374616b6500000000000000604482015290519081900360640190fd5b6001600160a01b0380861660009081526003602090815260408083209388168352929052206001015482111561378c576040805162461bcd60e51b815260206004820152601960248201527f4e6f7420656e6f7567682041524d20746f20756e7374616b6500000000000000604482015290519081900360640190fd5b6001600160a01b0385811660009081526003602081815260408084209489168452939052919020015443620151809091011115613810576040805162461bcd60e51b815260206004820152601e60248201527f43616e6e6f7420756e7374616b65207768656e20696e206c6f636b696e670000604482015290519081900360640190fd5b600083118061381f5750600082115b613870576040805162461bcd60e51b815260206004820152601e60248201527f556e7374616b6520616d6f756e742073686f756c64206e6f7420626520300000604482015290519081900360640190fd5b61387a8585613e02565b6001600160a01b038581166000908152600360209081526040808320938816835292905290812080546001909101546138b39190613621565b6001600160a01b038781166000908152600360208181526040808420948b1684529390529181208054889003808255600182018054899003905543919093015591925015613935576001600160a01b038781166000908152600360209081526040808320938a1683529290522080546001909101546139329190613621565b90505b8415613973576040516001600160a01b0387169086156108fc029087906000818181858888f19350505050158015613971573d6000803e3d6000fd5b505b83156139875761398761c0003088876141e9565b6001600160a01b03808816600090815260026020908152604080832060040180548688039081900390915560038352818420948b168452939091529020541580156139f857506001600160a01b038089166000908152600360209081526040808320938b1683529290522060010154155b15613a0757613a078789614842565b6040805187815260208101879052428183015290516001600160a01b03808a1692908b16917f1907f84451daa4312825b56f0a3cbc5428fd8ab66421c3730c64a7a558a0a4629181900360600190a3506001979650505050505050565b600080613a75436301312d00613c3d565b600054909150811015613aa25760008181548110613a8f57fe5b90600052602060002001549150506110e9565b600091505090565b600080805b600754811015613b4857836001600160a01b031660078281548110613ad057fe5b6000918252602090912001546001600160a01b03161480613b2957506002600060078381548110613afd57fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020600e015460ff165b15613b3357613b40565b613b3e826001613c7f565b505b600101613aaf565b50600081156121c0576000613b5d8684613c3d565b905060005b600754811015613c3357856001600160a01b031660078281548110613b8357fe5b6000918252602090912001546001600160a01b03161480613bdc57506002600060078381548110613bb057fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020600e015460ff165b15613be657613c2b565b816002600060078481548110613bf857fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020600b0180549091019055918101915b600101613b62565b5050949350505050565b6000610e4183836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250614977565b600082820183811015610e41576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b60006121c083612a17633b9aca00613cf38183888b613cf5565b905b600082613d0457506000610e44565b82820282848281613d1157fe5b0414610e415760405162461bcd60e51b8152600401808060200182810382526021815260200180614da66021913960400191505060405180910390fd5b6001600160a01b0381166000908152600260205260409020600c01544361708090910111801590613d9957506001600160a01b0381166000908152600260205260409020600b015415155b15613dff576001600160a01b03811660009081526002602081905260408220600b0154613dc591613c3d565b6001600160a01b0383166000908152600260205260409020600b81018054600a830180549185900390910190559190915543600c90910155505b50565b6001600160a01b038083166000908152600260208181526040808420600701546003835281852095871685529490915290912001548082038015613ec6576001600160a01b03858116600090815260036020908152604080832093881683529290529081208054600190910154613e799190613621565b90506000613e87838361367e565b6001600160a01b0380881660008181526005602090815260408083208054909601909555928b1681526003835283812091815291522060020185905550505b5050505050565b6001600160a01b0382166000908152600260205260409020600b015415613f58576001600160a01b0382166000908152600260205260408120600b0154613f149084613aaa565b6001600160a01b03848116600081815260026020526040808220600b8082018054968a16855292842001805496909503909501909355908152905543600c90910155505b5050565b6001600160a01b0381166000908152600260205260409020600e015460ff1615613f8557613dff565b6007546001148015613fc15750806001600160a01b03166007600081548110613faa57fe5b6000918252602090912001546001600160a01b0316145b15613fcb57613dff565b60005b6007548110156140aa57816001600160a01b031660078281548110613fef57fe5b6000918252602090912001546001600160a01b031614156140a25760078054600019810190811061401c57fe5b600091825260209091200154600780546001600160a01b03909216918390811061404257fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550600780548061407b57fe5b600082815260209020810160001990810180546001600160a01b03191690550190556140aa565b600101613fce565b5060005b60065481101561418a57816001600160a01b0316600682815481106140cf57fe5b6000918252602090912001546001600160a01b03161415614182576006805460001981019081106140fc57fe5b600091825260209091200154600680546001600160a01b03909216918390811061412257fe5b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550600680548061415b57fe5b600082815260209020810160001990810180546001600160a01b031916905501905561418a565b6001016140ae565b506001600160a01b038116600081815260026020908152604091829020600e01805460ff19166001179055815142815291517f867f1cb35d17df633b5091fce30f829edad5cf712f8d90315b67322af66bc3589281900390910190a250565b604080516001600160a01b0385811660248301528481166044830152606480830185905283518084039091018152608490920183526020820180516001600160e01b03166323b872dd60e01b178152925182516000948594938a169392918291908083835b6020831061426d5780518252601f19909201916020918201910161424e565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d80600081146142cf576040519150601f19603f3d011682016040523d82523d6000602084013e6142d4565b606091505b509150915081801561430257508051158061430257508080602001905160208110156142ff57600080fd5b50515b61433d5760405162461bcd60e51b8152600401808060200182810382526031815260200180614d3c6031913960400191505060405180910390fd5b505050505050565b60005b6001600160a01b0383166000908152600460205260409020548110156143ba576001600160a01b0383811660009081526004602052604090208054918416918390811061439157fe5b6000918252602090912001546001600160a01b031614156143b25750613f58565b600101614348565b506001600160a01b0391821660009081526004602090815260408220805460018101825590835291200180546001600160a01b03191691909216179055565b6001600160a01b0381166000908152600260205260409020600f0154156144c4576001600160a01b0381166000908152600260205260408120600f01546144449043036104b0613c3d565b905080156144c2576001600160a01b0382166000908152600260205260409020600d015481101561449e576001600160a01b0382166000908152600260205260409020600d81018054839003905543600f909101556144c2565b6001600160a01b0382166000908152600260205260408120600d8101829055600f01555b505b6001600160a01b0381166000908152600260205260409020600e015460ff16801561450b57506001600160a01b0381166000908152600260205260409020600d0154600c10155b15613dff576001600160a01b03166000908152600260205260409020600e01805460ff19169055565b6001600160a01b0381166000908152600260205260409020600e015460ff161561455d57613dff565b60005b6006548110156145aa57816001600160a01b03166006828154811061458157fe5b6000918252602090912001546001600160a01b031614156145a25750613dff565b600101614560565b506006546032111561460657600680546001810182556000919091527ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f0180546001600160a01b0319166001600160a01b038316179055613dff565b60008060026000600660008154811061461b57fe5b60009182526020808320909101546001600160a01b03168352820192909252604001902060040154905060015b6006548110156146da57600260006006838154811061466357fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020600401548211156146d25760026000600683815481106146a357fe5b60009182526020808320909101546001600160a01b031683528201929092526040019020600401549092509050815b600101614648565b506001600160a01b0383166000908152600260205260409020600401548110156147c3576006828154811061470b57fe5b600091825260209182902001546040805142815290516001600160a01b03909216927f769faec6b10880ee2ff7a725b1738167fd9a09506459f93df684a8b9b1377b9192918290030190a2826006838154811061476457fe5b60009182526020918290200180546001600160a01b0319166001600160a01b03938416179055604080514281529051928616927f0d0cc9af0673d7b305102b27ddcbda586fc74478a654e7e8f50f0ca5198246d6929181900390910190a25b505050565b6000806121c08484614a19565b600060806147e283614a32565b600f0b6fb17217f7d1cf79abc9e3b39803f2f6af02901c9050919050565b60008161480f57506000610e44565b50608081901c600f83900b908102604090811b6fffffffffffffffffffffffffffffffff841692909202901c0192915050565b60005b6001600160a01b0383166000908152600460205260409020548110156147c3576001600160a01b0383811660009081526004602052604090208054918416918390811061488e57fe5b6000918252602090912001546001600160a01b0316141561496f576001600160a01b0383166000908152600460205260409020805460001981019081106148d157fe5b60009182526020808320909101546001600160a01b0386811684526004909252604090922080549190921691908390811061490857fe5b600091825260208083209190910180546001600160a01b0319166001600160a01b03948516179055918516815260049091526040902080548061494757fe5b600082815260209020810160001990810180546001600160a01b031916905501905550613f58565b600101614845565b60008183614a035760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b838110156149c85781810151838201526020016149b0565b50505050905090810190601f1680156149f55780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b506000838581614a0f57fe5b0495945050505050565b60008082604085901b81614a2957fe5b04949350505050565b600080600f83900b680100000000000000008112614a52576040918201911d5b600160201b8112614a65576020918201911d5b620100008112614a77576010918201911d5b6101008112614a88576008918201911d5b60108112614a98576004918201911d5b60048112614aa8576002918201911d5b60028112614ab7576001820191505b603f19820160401b600f85900b607f8490031b6780000000000000005b6000811315614afa5790800260ff81901c8281029390930192607f011c9060011d614ad4565b509095945050505050565b60405180610240016040528060608152602001606081526020016060815260200160006001600160a01b03168152602001600063ffffffff1681526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200160001515815260200160008152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282614bd75760008555614c1d565b82601f10614bf057805160ff1916838001178555614c1d565b82800160010185558215614c1d579182015b82811115614c1d578251825591602001919060010190614c02565b50614c29929150614d26565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282614c635760008555614c1d565b82601f10614c7c5782800160ff19823516178555614c1d565b82800160010185558215614c1d579182015b82811115614c1d578235825591602001919060010190614c8e565b828054828255906000526020600020908101928215614c1d579160200282015b82811115614c1d57825182546001600160a01b0319166001600160a01b03909116178255602090920191600190910190614cc9565b6040518060800160405280600081526020016000815260200160008152602001600081525090565b5b80821115614c295760008155600101614d2756fe5472616e7366657248656c7065723a3a7472616e7366657246726f6d3a207472616e7366657246726f6d206661696c65644f6e6c79207370656369666965642070726f66697454616b65722063616e207769746864726177206d696e65726d696e65722070726f666974536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a26469706673582212203c2c91c3ca908d1611a1b957c8b51afb2b619740cda13ad8d0ca8f905b0f4f9664736f6c63430007060033",
		},
	}
	tester := buildEthereumInstance(t)
	defer tester.close()
	db := tester.ethereum.ChainDb()
	{
		statedb, err := state.New(tester.ethereum.BlockChain().CurrentBlock().Root(), state.NewDatabase(db), nil)
		assert.NoError(t, err)
		code := statedb.GetCode(systemcontracts.RiboseContractAddr)
		assert.Equal(t, genspec.Alloc[systemcontracts.RiboseContractAddr].Code, code)
		expectCode, _ := hex.DecodeString((*systemcontracts.AbiesUpgrade.Networks[genspec.Config.ChainID.String()])[systemcontracts.RiboseContractAddr].Code)
		assert.NotZero(t, bytes.Compare(expectCode, code))
	}

	buildBlocks(t, tester, 100, nil, nil, nil, nil)
	{
		statedb, err := state.New(tester.ethereum.BlockChain().CurrentBlock().Root(), state.NewDatabase(db), nil)
		assert.NoError(t, err)
		code := statedb.GetCode(systemcontracts.RiboseContractAddr)
		assert.NotZero(t, bytes.Compare(genspec.Alloc[systemcontracts.RiboseContractAddr].Code, code))
		expectCode, _ := hex.DecodeString((*systemcontracts.AbiesUpgrade.Networks[genspec.Config.ChainID.String()])[systemcontracts.RiboseContractAddr].Code)
		assert.Equal(t, expectCode, code)
	}
}
